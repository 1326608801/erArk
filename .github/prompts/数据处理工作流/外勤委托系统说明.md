# 外勤委托系统说明

## 概述
外勤委托系统是游戏中的一个重要功能，允许玩家派遣干员执行各种任务以获得资源、经验、素质等奖励。本文档详细说明了外勤委托系统的数据结构、代码逻辑以及相关文件之间的关系。

## 核心文件关系

### 1. 数据文件：`/data/csv/Commission.csv`
存储所有委托任务的原始数据，包含以下字段：
- `cid`：委托ID（唯一标识）
- `name`：委托名称
- `country_id`：国家ID（-1表示通用委托）
- `level`：委托等级（1-6级）
- `type`：委托类型（资源/源石/成长/势力/角色/支线）
- `people`：需要派遣的人数
- `time`：耗时天数
- `demand`：具体需求（特殊格式字符串）
- `reward`：具体奖励（特殊格式字符串）
- `related_id`：关联的前置委托ID（-1表示无）
- `special`：是否为特殊委托（0=常规，1=特殊）
- `description`：委托描述

### 2. 配置定义：`/Script/Config/config_def.py`
定义了`Commission`类，作为委托数据的Python对象模型。

### 3. 配置加载：`/Script/Config/game_config.py`
- 定义全局配置字典：
  - `config_commission`：存储所有委托对象
  - `config_commission_id_by_country`：按国家分组的委托ID列表
- `load_commission()`函数负责从JSON加载并创建委托对象

### 4. UI面板：`/Script/UI/Panel/field_commission_panel.py`
实现委托系统的用户界面和核心逻辑功能。

## 数据流程

```
Commission.csv → buildconfig.py → data.json → game_config.load_commission() → 游戏使用
```

1. **构建阶段**：`buildconfig.py`读取CSV文件，转换为JSON格式
2. **加载阶段**：游戏启动时，`game_config.py`从JSON加载数据
3. **运行阶段**：游戏通过配置字典访问委托数据

## 需求和奖励格式

### 需求/奖励类型前缀
- `r_`：资源（如 `r_22_2` = 2份22号资源）
- `a_`：能力（如 `a_42_10` = 10点42号能力）
- `e_`：经验（如 `e_81_20` = 20点81号经验）
- `j_`：宝珠（如 `j_11_5000` = 5000个11号宝珠）
- `t_`：素质（如 `t_171_1` = 获得171号素质）
- `c_`：角色（如 `c_291_1` = 需要291号角色出场）
- `m_`：委托状态（如 `m_56_-1` = 56号委托变为不可完成）
- `声望_`：声望值（如 `声望_0_50` = 当地声望+50）
- `好感_`：好感度（如 `好感_7_100` = 7号角色好感+100）
- `信赖_`：信赖值
- `攻略_`：攻略程度（如 `攻略_291_3` = 291号角色攻略程度3）
- `特产_`：当地特产
- `追捕_`：追捕任务

### 复合需求
使用`&`连接多个需求，如：`a_42_4&a_45_4`表示需要42号能力4点且45号能力4点。

## 核心功能函数

### `get_commission_demand_and_reward()`
处理委托的需求检查和奖励发放：
- 解析需求/奖励字符串
- 检查是否满足条件
- 扣除/增加相应资源
- 返回满足状态和描述文本

### `process_commission_text()`
处理单个需求/奖励文本项：
- 解析文本格式
- 获取对应的资源/能力等数据
- 执行扣除或增加操作
- 生成显示文本

### `update_field_commission()`
更新外勤委托状态：
- 判断进行中的委托是否完成
- 结算完成的委托奖励
- 刷新可接取的委托列表

### `create_temp_commission()`
动态创建临时委托：
- 用于特殊事件生成的委托
- 自动分配可用的委托ID
- 更新CSV文件以持久化

## 委托执行流程

1. **展示阶段**
   - 根据罗德岛位置获取当地委托
   - 过滤满足条件的委托（等级、前置等）
   - 显示委托列表

2. **准备阶段**
   - 选择派遣人员（满足人数要求）
   - 选择载具（满足运载量要求）
   - 检查其他需求（资源、能力等）

3. **执行阶段**
   - 扣除所需资源
   - 设置人员离线状态
   - 记录委托开始时间和预计完成时间
   - 考虑载具速度对时间的影响

4. **结算阶段**
   - 检查委托是否到期
   - 发放奖励（资源、经验、素质等）
   - 处理特殊奖励（新干员、载具等）
   - 人员上线并触发相关事件

## 特殊机制

### 载具系统
- 载具提供运载量，满足委托的运输需求
- 载具速度影响委托完成时间
- 载具可能在委托中损坏

### 招募机制
- 某些委托完成后可能招募到新干员
- 概率与委托等级相关
- 只能招募当地出生的干员

### 动态委托
- 支持运行时创建临时委托
- 用于特殊事件（如追捕逃犯）
- 自动持久化到CSV文件

## 与其他系统的交互

1. **角色系统**：检查角色能力、设置离线状态
2. **资源系统**：扣除和增加各类资源
3. **声望系统**：影响国家/势力声望
4. **时间系统**：计算委托完成时间
5. **地图系统**：根据位置显示不同委托
6. **事件系统**：触发委托相关的特殊事件

## 扩展说明

### 添加新委托
1. 在`Commission.csv`中添加新行
2. 运行`buildconfig.py`重新构建
3. 委托会自动加载到游戏中

### 添加新的需求/奖励类型
1. 在`process_commission_text()`中添加新的类型处理
2. 实现对应的检查和结算逻辑
3. 更新相关的显示文本生成

### 国家特定委托
- 设置`country_id`为特定国家ID
- 委托只在罗德岛位于该国家时显示
- 通用委托使用`country_id = -1`

## 注意事项

1. 委托ID必须唯一，建议使用分段管理（如1-999通用，1000+特殊）
2. 需求和奖励格式必须严格遵循约定，否则解析会出错
3. 特殊委托完成后会加入`finished_field_commissions_set`，不可重复完成
4. 动态创建的委托会追加到CSV文件末尾，注意备份